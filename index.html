<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Evaluaci√≥n de Carteles - Simposio M√©dico</title>
    
    <!-- Librer√≠a Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Base (styles.css integrado y mejorado) */
        :root{
            /* Colores inspirados en la identidad visual */
            --bg:#f9fafb; /* Fondo muy claro */
            --card:#ffffff;
            --muted:#6b7280;
            --primary-1:#5b21b6; /* Morado Oscuro/Vino */
            --primary-2:#8b5cf6; /* Morado Claro */
            --accent:#7c3aed;
            --success:#16a34a;
            --danger:#ef4444;
        }

        *{box-sizing:border-box;font-family:Inter,system-ui,Arial;margin:0;padding:0}
        body{background-color: var(--bg); color:#0b1220; min-height:100vh}
        /* Correcci√≥n: Usa m√°s ancho de pantalla */
        .container{max-width:1280px; width: 98%; margin:32px auto;padding:18px} 
        .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;}
        .topbar .logo{height:50px;margin-right:12px; border-radius: 8px;} /* Logos m√°s grandes y con borde suave */
        .topbar .version{color:var(--muted);font-size:13px; font-weight: 600; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px;}

        /* Correcci√≥n: Permite que el grid principal crezca */
        .main-grid{display:grid;grid-template-columns:360px 1fr;gap:24px;align-items:start} 
        .card{background:var(--card);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(12,16,40,0.08)} /* Sombra m√°s pronunciada y bordes m√°s redondos */
        .login-card h2{font-size:24px;margin-bottom:8px; font-weight: 800;}
        .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
        label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
        input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ef;margin-bottom:16px;font-size:14px; transition: border-color .2s}
        input:focus, textarea:focus, select:focus { border-color: var(--primary-2); outline: none; }

        .btn{display:inline-flex; align-items: center; justify-content: center; padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:700; gap: 8px; transition: all .2s}
        .btn.primary{width:100%;color:white;background:linear-gradient(90deg,var(--primary-1),var(--primary-2));}
        .btn.primary:hover{box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);}
        .btn.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--muted);}
        .btn.ghost:hover{background-color: #f3f4f6;}
        .btn.danger{background-color: var(--danger); color: white;}
        .btn.danger:hover{opacity: 0.9;}

        .error{color:var(--danger);margin-bottom:8px}
        .hidden{display:none}

        /* Estilos para el campo de contrase√±a y el bot√≥n de visibilidad */
        .password-container{position:relative; margin-bottom: 16px;}
        .password-container input{margin-bottom: 0;}
        .password-container .toggle-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:18px;padding:0;}

        .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .welcome{font-size:24px;font-weight:800; color: var(--primary-1);}
        .small{font-size:13px;color:var(--muted)}

        .work-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px} /* Ajuste a 250px */
        .work-card{padding:15px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfbff);border:1px solid #eef2ff; transition: all .2s}
        .work-card:hover{box-shadow: 0 4px 15px rgba(0,0,0,0.1)}
        .work-card strong{display:block;font-size:16px;margin-bottom:8px; color: #1f2937;}
        .work-meta{font-size:14px;color:#4b5563;}

        .top-actions{display:flex;gap:10px;align-items:center}

        .evaluated-badge{display:inline-block;background:rgba(34,197,94,0.12);color:var(--success);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}

        .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .form-row .full{grid-column:1/-1}

        /* Modal Styles */
        .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:flex;align-items:center;justify-content:center;z-index:9999; backdrop-filter: blur(4px);}
        .modal{background:white;padding:24px;border-radius:16px;max-width:720px;width:96%;box-shadow:0 12px 40px rgba(8,10,30,0.3)}
        
        .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
        .progress > div{height:100%;background:linear-gradient(90deg,var(--primary-1),var(--primary-2)); transition: width 0.5s ease-out;}

        .admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}

        .footer{margin-top:32px;text-align:center;color:var(--muted);font-size:13px}
        
        /* Evaluation specific styles */
        .eval-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
        .eval-card{border:1px solid #e6e9ef; padding:15px; border-radius:10px; background-color: #f9f9ff;}
        .eval-card h4{font-weight:800; color:var(--primary-1); font-size:16px; margin-bottom: 6px;}
        .score-row{display:flex; justify-content:space-between; align-items:center; margin-top: 10px;}
        .score-input-custom{border:1px solid #ccc; padding: 6px 10px; width: 70px; text-align: center; border-radius: 6px; font-weight: 600;}
        .deduction{color:var(--danger);}
        .bonus{color:var(--success);}

        /* Custom Alert/Toast Styles */
        #custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .alert-success { background-color: #d1fae5; color: var(--success); border: 1px solid #a7f3d0; }
        .alert-error { background-color: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }
        .alert-info { background-color: #e0f2fe; color: var(--primary-1); border: 1px solid #bae6fd; }

        /* responsive */
        @media (max-width:900px){
            .main-grid{grid-template-columns:1fr; padding-bottom:60px}
            .login-card{order:2}
            .topbar .logo{height: 40px;}
        }

    </style>

    <script type="module">
        // ============================================================
        //  CONFIGURACI√ìN Y DATOS DE LA APLICACI√ìN
        // ============================================================

        // URL de tu Web App Google Apps Script
        const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzatgCyA9JOC5NGiaVhyWzBG9V69-jzlyPAW03HtI-_pMKd3K5N8zxai1dUuKNcf_s0/exec";

        // --- users.js ---
        const USERS = [
          { user: "admin", pass: "Admin2025", name: "Administrador General", role: "admin" },
          { user: "araceli.hernandez", pass: "Simposio2025", name: "Araceli Hern√°ndez Zavala", role: "juez" },
          { user: "marycarmen.godinez", pass: "Simposio2025", name: "Marycarmen Godinez Victoria", role: "juez" },
          { user: "claudia.calzada", pass: "Simposio2025", name: "Claudia Camelia Calzada Mendoza", role: "juez" },
          { user: "paola.zarate", pass: "Simposio2025", name: "Paola Berenice Zarate Segura", role: "juez" },
          { user: "ivonne.maciel", pass: "Simposio2025", name: "Ivonne Maciel Arciniega Mart√≠nez", role: "juez" },
          { user: "aldo.resendiz", pass: "Simposio2025", name: "Aldo Arturo Res√©ndiz Albor", role: "juez" },
          { user: "javier.perez", pass: "Simposio2025", name: "Javier P√©rez Dur√°n", role: "juez" },
          { user: "paula.saldana", pass: "Simposio2025", name: "Paula Salda√±a", role: "juez" },
          { user: "elena.cruz", pass: "Simposio2025", name: "Elena de La Cruz Herrera Cogco", role: "juez" },
          { user: "nury.perez", pass: "Simposio2025", name: "Nury P√©rez Hern√°ndez", role: "juez" },
          { user: "enrique.mendez", pass: "Simposio2025", name: "Enrique M√©ndez-Bolaina", role: "juez" },
          { user: "edgar.cano", pass: "Simposio2025", name: "Edgar Cano Europa", role: "juez" },
          { user: "javier.flores", pass: "Simposio2025", name: "Javier Flores Estrada", role: "juez" },
          { user: "araceli.montoya", pass: "Simposio2025", name: "Araceli Montoya Estrada", role: "juez" }
        ];

        // --- works.js ---
        const WORKS = {
          "II-008-PL-MC":"Monserrat Andrea Ortiz Cortes", "II-009-PL-MC":"Castillo Olvera Itzel Jimena", "II-010-PL-NT":"Edgar Valeria de la Cruz", "II-012-PL-MC":"Marisol Garay Contreras",
          "II-016-PL-NT":"Natalia Valeria Sillerico Illanes", "II-020-PL-NT":"Daniela Torres Velasco", "II-022-PL-NT":"Astrid Adamari De la Rosa Cordero", "II-024-PL-NT":"Sara Gabriela Guadarrama Tovar",
          "II-025-PL-NT":"Astrid Sophia Careaga Arceo", "II-027-PL-MC":"Elena Abigail P√©rez Ham", "II-029-PL-ET":"F√°tima Monserrat √Åvila Quintero", "II-032-PL-NT":"Paz Pe√±a Dana Paola",
          "II-033-PL-ET":"Mariana Berenice L√≥pez Arenas", "II-039-PL-MC":"Ana Camila Ram√≠rez Ortiz", "II-043-PL-NT":"Dilan Rodr√≠guez Lagos", "II-045-PL-NT":"Arianys Carolina Tovar Escobar",
          "II-048-PL-MC":"Anel Camacho Dorantes", "II-050-PL-NT":"Alberto Jaret Mej√≠a Meza", "II-051-PL-GE":"Yuleny Cervantes Fosado", "II-054-PL-NT":"Monserrat Bracho",
          "II-058-PL-NT":"Xaris L√≥pez Sol√≠s", "II-059-PL-NT":"Gillian Yazm√≠n Sosa Maldonado", "II-060-PL-GE":"Jos√© Juli√°n L√≥pez Hern√°ndez", "II-062-PL-NT":"Laura Alessandra Ram√≠rez V√°zquez",
          "II-064-PL-NT":"Anayeli Panzo Mayahua", "II-066-PL-NT":"Valery Rosales Rojas", "II-068-PL-PG":"Mar√≠a Elizabeth S√°nchez Romero", "II-075-PL-NT":"Negrete Ch√°vez Dalia Isamar",
          "II-076-PL-NT":"Axel Emanuel Moctezuma Garc√≠a", "II-086-PL-ET":"Erick Santiago Mendoza Palacios", "II-089-PL-ET":"Jessamyn Reyna Crespo Sandoval", "II-091-PL-ET":"Joslay Cabrera Caballero",
          "II-094-PL-NT":"Anaya Herrera Vania", "II-095-PL-ET":"Merary Jael Diaz Espinoza", "II-096-PL-ET":"Nadia Meritxell Vargas Freyre", "II-098-PL-NT":"Valeria Yareli Salazar Segura",
          "II-001-PP-NT":"Alexis Alejandro Garc√≠a Rivero", "II-002-PP-NT":"Antonio √Åvila Guerrero", "II-003-PP-NT":"Yara Irene L√≥pez Dionicio", "II-004-PP-NT":"Romina Mar√≠a Valladares Ocampo",
          "II-006-PP-GE":"Juan Pablo Gonz√°lez Dom√≠nguez", "II-007-PP-NT":"Israel Lara Vega", "II-011-PP-PG":"Ivonne del Socorro Guti√©rrez Ruiz", "II-013-PP-GE":"Giselle Barrera Z√°rate",
          "II-014-PP-GE":"Jos√© Luis Marroqu√≠n Caratachea", "II-015-PP-PG":"Ram√≥n L√≥pez Ocampo", "II-019-PP-ET":"Rogelio Iv√°n G√≥mez Escobedo", "II-023-PP-GE":"Itzel Feria Figueroa",
          "II-036-PP-NT":"Luis Jos√© Pinto Garc√≠a", "II-044-PP-ET":"Luis Mario S√°nchez Palestino", "II-047-PP-NT":"V√≠ctor Jes√∫s Escudero Huerta", "II-049-PP-ET":"Ernesto Santill√°n Arcos",
          "II-053-PP-GE":"Sally Silva Castro", "II-055-PP-MC":"Angelica Casta√±eda de la Fuente", "II-057-PP-NT":"Goretti Araneth L√≥pez Villafa√±a", "II-061-PP-NT":"Luis Armando Garc√≠a Pedraza",
          "II-069-PP-NT":"Guillermina Chavaro Francisco", "II-070-PP-NT":"Mar√≠a de los √Ångeles Rodr√≠guez Garc√≠a", "II-072-PP-NT":"Karla Reyes Alvarado", "II-081-PP-NT":"Stefany Alamilla Cuellar",
          "II-082-PP-NT":"Marcos Uriel Gonz√°lez P√©rez", "II-083-PP-NT":"Andrea Capaceta Osuna", "II-085-PP-NT":"Citlali G√≥mez M√°rquez", "II-088-PP-MC":"Karen Nayeli Hern√°ndez V√°zquez",
          "II-092-PP-GE":"Pahola del Carmen Rodr√≠guez P√©rez", "II-093-PP-NT":"Miguel Andr√©s Vald√©s Guevara", "II-097-PP-ET":"Lourdes Astrid Serrano Quilant√°n"
        };

        // --- assignments.js ---
        const ASSIGNMENTS = {
          "araceli.hernandez": ["II-008-PL-MC","II-039-PL-MC"],
          "marycarmen.godinez": ["II-009-PL-MC","II-043-PL-NT","II-047-PP-NT","II-088-PP-MC"],
          "claudia.calzada": ["II-010-PL-NT","II-045-PL-NT","II-049-PP-ET","II-092-PP-GE"],
          "paola.zarate": ["II-012-PL-MC","II-048-PL-MC","II-068-PL-PG","II-004-PP-NT","II-053-PP-GE","II-093-PP-NT"],
          "ivonne.maciel": ["II-016-PL-NT","II-050-PL-NT","II-075-PL-NT","II-006-PP-GE","II-055-PP-MC","II-097-PP-ET"],
          "aldo.resendiz": ["II-020-PL-NT","II-051-PL-GE","II-076-PL-NT","II-007-PP-NT","II-057-PP-NT"],
          "javier.perez": ["II-022-PL-NT","II-054-PL-NT","II-086-PL-ET","II-011-PP-PG","II-061-PP-NT"],
          "paula.saldana": ["II-024-PL-NT","II-058-PL-NT","II-089-PL-ET","II-013-PP-GE","II-069-PP-NT"],
          "elena.cruz": ["II-025-PL-NT","II-059-PL-NT","II-070-PP-NT","II-091-PL-ET"],
          "nury.perez": ["II-027-PL-MC","II-060-PL-GE","II-094-PL-NT","II-015-PP-PG","II-072-PP-NT"],
          "enrique.mendez": ["II-029-PL-ET","II-062-PL-NT","II-095-PL-ET","II-019-PP-ET","II-081-PP-NT"],
          "edgar.cano": ["II-032-PL-NT","II-064-PL-NT","II-096-PL-ET","II-023-PP-GE","II-082-PP-NT"],
          "javier.flores": ["II-033-PL-ET","II-066-PL-NT","II-098-PL-NT","II-036-PP-NT","II-083-PP-NT"],
          "araceli.montoya": ["II-001-PP-NT","II-044-PP-ET","II-085-PP-NT"]
        };

        // --- Criterios de Evaluaci√≥n (100 Puntos) ---
        const CRITERIA = [
            // I. Fondo (Contenido Cient√≠fico) - Max 55 puntos
            { id: 'titulo', category: 'I. Fondo (Contenido Cient√≠fico)', max: 5, type: '3-point', name: 'T√≠tulo y Congruencia', desc: 'Claridad, pertinencia, y correcta identificaci√≥n.' },
            { id: 'introduccion', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Introducci√≥n y Antecedentes', desc: 'Contextualizaci√≥n y justificaci√≥n del tema.' },
            { id: 'metodologia', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Metodolog√≠a', desc: 'Claridad en el dise√±o y procedimientos.' },
            { id: 'resultados', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Resultados', desc: 'Presentaci√≥n objetiva y completa de datos.' },
            { id: 'conclusiones', category: 'I. Fondo (Contenido Cient√≠fico)', max: 5, type: '3-point', name: 'Conclusiones', desc: 'Consistencia con los resultados obtenidos.' },
            
            // II. Forma (Dise√±o y Formato) - Max 35 puntos
            { id: 'banner', category: 'II. Forma (Dise√±o y Formato)', max: 5, type: 'yes-no', name: 'Banner y Elementos', desc: 'Inclusi√≥n de logos y cumplimiento de requisitos. (0 o 5 puntos)' },
            { id: 'diseno', category: 'II. Forma (Dise√±o y Formato)', max: 15, type: 'full', name: 'Dise√±o y Congruencia Visual', desc: 'Equilibrio, tipograf√≠a legible y uso eficiente.' },
            { id: 'graficas', category: 'II. Forma (Dise√±o y Formato)', max: 15, type: 'full', name: 'Uso de Tablas y Gr√°ficas', desc: 'Claridad, calidad de figuras y citaci√≥n.' }, 

            // III. Referencias y Presentaci√≥n - Max 10 puntos
            { id: 'referencias', category: 'III. Referencias y Presentaci√≥n', max: 5, type: 'yes-no', name: 'Referencias Bibliogr√°ficas', desc: 'Formato consistente y adecuado. (0 o 5 puntos)' },
            { id: 'defensa', category: 'III. Referencias y Presentaci√≥n', max: 5, type: 'full', name: 'Defensa y S√≠ntesis', desc: 'Dominio del tema y capacidad de s√≠ntesis.' },

            // IV. BONIFICACI√ìN (Puntos Extra) - Max +15 puntos
            { id: 'innovacion', category: 'IV. Bonificaci√≥n y Deducci√≥n', max: 15, type: 'bonus', name: 'Innovaci√≥n y Originalidad', desc: 'Aporta nuevo conocimiento o enfoque metodol√≥gico.' },

            // V. DEDUCCI√ìN (Restan Puntos) - Max -20 puntos
            { id: 'tiempo', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Manejo del Tiempo', desc: 'Excedi√≥ o no utiliz√≥ el tiempo. (M√°x -10 puntos)' },
            { id: 'ortografia', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Redacci√≥n y Ortograf√≠a', desc: 'Errores gramaticales o de sintaxis. (M√°x -10 puntos)' },
        ];


        let currentUser = null;
        let currentRole = null;
        let currentJudge = null;
        
        // --- L√≥gica del Sistema ---

        // Funci√≥n para alternar la visibilidad de la contrase√±a en el login
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password-btn');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà'; // Ojo tachado
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è'; // Ojo
            }
        }


        // Funci√≥n auxiliar para calcular el puntaje total
        function calculateScore() {
            const form = document.getElementById('eval-form');
            if (!form) return 0;

            let totalScore = 0;
            let totalBonus = 0;
            let totalDeduction = 0;

            for (const item of CRITERIA) {
                let score = 0;
                
                if (item.type === '3-point' || item.type === 'yes-no') {
                    // Leer de SELECT
                    const select = document.querySelector(`select[name="${item.id}"]`);
                    score = parseInt(select ? select.value : 0) || 0;
                } else {
                    // Leer de INPUT (full, bonus, deduction)
                    const numberInput = document.getElementById(`${item.id}-score`);
                    if (numberInput) score = parseInt(numberInput.value) || 0;
                }
                
                // Aplicar el l√≠mite m√°ximo del criterio, sin importar el tipo
                const safeScore = Math.min(Math.abs(score), item.max); 
                
                if (item.type === 'bonus') {
                    totalBonus += safeScore;
                } else if (item.type === 'deduction') {
                    totalDeduction += safeScore;
                } else {
                    totalScore += safeScore; // Criterios Base
                }
            }
            
            // La deducci√≥n se resta, el bonus se suma
            let finalScore = totalScore + totalBonus - totalDeduction;
            if (finalScore < 0) finalScore = 0; // Asegurar que el puntaje no sea negativo.

            const scoreDisplay = document.getElementById('total-score-display');
            if (scoreDisplay) scoreDisplay.textContent = finalScore;
            
            return finalScore;
        }

        // --- Manejo de la Evaluaci√≥n ---
        async function saveEvaluation(id) {
            const fd = new FormData(document.getElementById("eval-form"));
            const scores = {};
            
            // 1. Recoger puntajes detallados
            for (const item of CRITERIA) {
                let score = 0;
                
                if (item.type === '3-point' || item.type === 'yes-no') {
                     // Leer de SELECT
                    const select = document.querySelector(`select[name="${item.id}"]`);
                    score = parseInt(select ? select.value : 0) || 0;
                } else {
                    // Leer de INPUT (full, bonus, deduction)
                    const numberInput = document.getElementById(`${item.id}-score`);
                    if (numberInput) score = parseInt(numberInput.value) || 0;
                }
                scores[item.id] = score; // Guardar el valor ingresado
            }

            const totalScore = calculateScore(); // Obtener el puntaje final calculado

            const payload = {
                timestamp: new Date().toISOString(),
                staticJudgeId: currentUser, 
                judgeName: currentJudge.name,
                posterId: id,
                posterTitle: WORKS[id] || "T√≠tulo Desconocido",
                totalScore: totalScore,
                scores: scores,
                observations: fd.get("comentarios") || ""
            };

            // 2. Guardar Localmente y Bloquear
            localStorage.setItem(`eval_${currentUser}_${id}`, JSON.stringify(payload));

            // 3. Enviar a Google Sheets (CORRECCI√ìN CR√çTICA: Enviar JSON con header correcto)
            try {
                // Se env√≠a el payload JSON directamente.
                const response = await fetch(SHEETS_WEBAPP_URL, {
                    method:"POST",
                    headers: {
                        'Content-Type': 'application/json', // Indicamos que el cuerpo es JSON
                    },
                    body: JSON.stringify(payload)
                });

                // Aunque el script usa ContentService.createTextOutput, podemos intentar parsear
                // la respuesta para verificar el estado si CORS lo permite.
                if (response.ok || response.type === 'opaque') {
                    // Si response.ok es true, o si estamos en modo no-cors y es una respuesta opaca
                    console.log("Env√≠o a Google Sheets iniciado o exitoso.");
                    showAlert("Evaluaci√≥n guardada y enviada a Sheets.", "success");
                } else {
                    const errorText = await response.text();
                    console.warn("Fallo al enviar a Sheets (Respuesta no OK):", errorText);
                    showAlert("Error al enviar a Sheets, pero guardado localmente.", "error");
                }
                
            } catch(e){ 
                console.warn("Fallo en la petici√≥n a Sheets (t√≠pico en problemas de red/CORS):", e); 
                showAlert("Error de conexi√≥n al enviar a Sheets, pero guardado localmente.", "error");
            }

            showDashboard();
        }

        // --- Funciones de Login y Dashboard ---

        function tryLogin(){
          const u = document.getElementById("username").value.trim();
          const p = document.getElementById("password").value.trim();
          const err = document.getElementById("login-error");
          err.classList.add("hidden"); err.textContent = "";

          const match = USERS.find(x => x.user === u && x.pass === p);
          if(!match){
            err.textContent = "Usuario o contrase√±a incorrectos.";
            err.classList.remove("hidden");
            return;
          }

          currentUser = match.user; currentRole = match.role; currentJudge = match;
          localStorage.setItem("simposioUser", currentUser); localStorage.setItem("simposioRole", currentRole);

          showDashboard();
        }

        window.addEventListener("load", () => {
          const u = localStorage.getItem("simposioUser");
          const r = localStorage.getItem("simposioRole");
          if(u && r){
            currentUser = u; currentRole = r; currentJudge = USERS.find(x=>x.user===u);
            showDashboard();
          }
        });

        function showDashboard(){
          const loginCard = document.getElementById("login-card");
          if(loginCard) loginCard.classList.add("hidden");
          const root = document.getElementById("app-root");
          root.classList.remove("hidden");
          if(currentRole === "admin") renderAdmin();
          else renderJudge();
        }

        // --- Render Judge Dashboard ---
        function renderJudge(){
          const root = document.getElementById("app-root");
          const assigned = ASSIGNMENTS[currentUser] || [];
          // Icono de Juez: üßë‚Äç‚öñÔ∏è
          let html = `<div class="header-row"><div><div class="welcome">üßë‚Äç‚öñÔ∏è Bienvenido, ${currentJudge.name}</div><div class="small">Juez: ${currentUser}</div></div><div class="top-actions"><button class="btn ghost" onclick="logout()">üö™ Cerrar sesi√≥n</button></div></div>`;

          html += `<div class="card"><h3 class="small">Mis trabajos asignados</h3>`;
          if(assigned.length===0) html += `<p class="small">No tiene trabajos asignados. Por favor contacte al administrador.</p>`;
          html += `<div class="work-list">`;
          for(const id of assigned){
            const student = WORKS[id] || "";
            const doneKey = `eval_${currentUser}_${id}`;
            const data = localStorage.getItem(doneKey);
            const done = data ? true : false;
            let totalScore = "N/A";

            if (done) {
                try {
                    const obj = JSON.parse(data);
                    totalScore = obj.totalScore || 0;
                } catch (e) { /* silent fail */ }
            }

            html += `<div class="work-card">
                        <strong>${id}</strong>
                        <div class="work-meta">${student}</div>
                        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                            ${done ? 
                                `<span class="evaluated-badge">‚úÖ Finalizado (${totalScore} Pts)</span>
                                 <button class="btn ghost" style="width:auto; padding: 8px 10px; font-size:12px; color: var(--danger);" onclick="confirmResetEvaluation('${id}')">üîÑ Reiniciar</button>`
                                : `<button class="btn primary" onclick="openEvaluation('${id}')">üìù Evaluar</button>`}
                        </div>
                     </div>`;
          }
          html += `</div></div>`;
          root.innerHTML = html;
        }

        // --- Reiniciar Evaluaci√≥n (Funciones de soporte) ---
        function confirmResetEvaluation(id) {
            const student = WORKS[id] || "Desconocido";
            openModal(`
                <h3>üîÑ Confirmar Reinicio de Evaluaci√≥n</h3>
                <p class="muted">¬øEst√° seguro de que desea reiniciar la evaluaci√≥n para el trabajo <strong>${id}</strong> (${student})? Esto borrar√° el puntaje guardado localmente.</p>
                <button class="btn danger" style="width:100%" onclick="resetEvaluation('${id}')">
                    üóëÔ∏è S√≠, Borrar y Reiniciar Evaluaci√≥n
                </button>
            `);
        }
        
        function resetEvaluation(id) {
            closeModal();
            const key = `eval_${currentUser}_${id}`;
            localStorage.removeItem(key);
            showAlert(`Evaluaci√≥n del trabajo ${id} reiniciada.`, "info");
            showDashboard();
        }

        // --- Render Evaluation Form ---
        function openEvaluation(id){
            const student = WORKS[id] || "";
            const criteriaSet = CRITERIA; 
            const existingData = localStorage.getItem(`eval_${currentUser}_${id}`);
            const data = existingData ? JSON.parse(existingData) : {};
            const scores = data.scores || {};


            let criteriaHtml = '';
            let currentCategory = '';

            criteriaSet.forEach(item => {
                if (item.category !== currentCategory) {
                    criteriaHtml += `<h4 style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:5px;">${item.category}</h4>`;
                    currentCategory = item.category;
                }

                let inputField = '';
                
                if (item.type === '3-point') {
                     inputField = `
                         <div class="score-row">
                            <label class="small">${item.desc}</label>
                            <div style="display:flex; gap: 8px;">
                                <select name="${item.id}" class="score-input-custom" required onchange="calculateScore()">
                                    <option value="">--</option>
                                    <option value="0" ${scores[item.id] == 0 ? 'selected' : ''}>0</option>
                                    <option value="3" ${scores[item.id] == 3 ? 'selected' : ''}>3</option>
                                    <option value="5" ${scores[item.id] == 5 ? 'selected' : ''}>5</option>
                                </select>
                            </div>
                        </div>
                     `;
                } else if (item.type === 'yes-no') {
                     inputField = `
                         <div class="score-row">
                            <label class="small">${item.desc}</label>
                            <div style="display:flex; gap: 8px;">
                                <select name="${item.id}" class="score-input-custom" required onchange="calculateScore()">
                                    <option value="">--</option>
                                    <option value="0" ${scores[item.id] == 0 ? 'selected' : ''}>No (0)</option>
                                    <option value="5" ${scores[item.id] == 5 ? 'selected' : ''}>S√≠ (5)</option>
                                </select>
                            </div>
                        </div>
                     `;
                } else {
                    const classType = item.type === 'deduction' ? 'deduction' : (item.type === 'bonus' ? 'bonus' : '');
                    const value = scores[item.id] !== undefined ? scores[item.id] : 0;

                    inputField = `
                        <div class="score-row ${classType}">
                           <label class="small">${item.desc} (M√°x. ${item.max})</label>
                           <input type="number" id="${item.id}-score" name="${item.id}" class="score-input-custom" min="0" max="${item.max}" value="${value}" oninput="calculateScore()">
                        </div>
                    `;
                }
                criteriaHtml += `<div class="eval-card">${inputField}</div>`;
            });


            const root = document.getElementById("app-root");
            root.innerHTML = `<div class="card"><button class="btn ghost" onclick="showDashboard()">‚Üê Volver al Panel</button>
                <h3>üìù Evaluaci√≥n de Trabajo</h3>
                <div class="small">${id} ‚Äî ${student}</div>
                <div style="margin-top:15px; font-size: 20px; font-weight: 800; color: var(--primary-1);">
                    Puntuaci√≥n Total: <span id="total-score-display">${data.totalScore || 0}</span> / 100
                </div>

                <form id="eval-form" style="margin-top:16px">
                    <div class="eval-grid">${criteriaHtml}</div>
                    
                    <div style="margin-top:20px; border-top: 1px solid #eee; padding-top: 16px;">
                        <label>‚úçÔ∏è Observaciones/Comentarios</label>
                        <textarea name="comentarios" rows="4">${data.observations || ''}</textarea>
                    </div>

                    <div style="margin-top:20px;display:flex;gap:10px">
                        <button class="btn primary" type="submit">‚úÖ Guardar evaluaci√≥n (Finalizar)</button>
                        <button type="button" class="btn ghost" onclick="showDashboard()">‚ùå Cancelar</button>
                        <button type="button" class="btn danger" style="width: auto;" onclick="confirmResetEvaluation('${id}')">üóëÔ∏è Reiniciar Evaluaci√≥n</button>
                    </div>
                </form>
            </div>`;

            // Re-bind events for score calculation on input change
            document.getElementById("eval-form").addEventListener("input", calculateScore);
            document.getElementById("eval-form").addEventListener("change", calculateScore);


            document.getElementById("eval-form").addEventListener("submit", e=>{
                e.preventDefault();
                saveEvaluation(id);
            });
            calculateScore(); // Initial calculation
        }

        // --- Render Admin Dashboard ---
        function renderAdmin(){
          const root = document.getElementById("app-root");
          // Icono de Admin: ‚öôÔ∏è
          let html = `<div class="header-row"><div><div class="welcome">‚öôÔ∏è Panel de Administraci√≥n</div><div class="small">Usuario: ${currentJudge.name}</div></div><div class="top-actions">
          <button class="btn ghost" onclick="showPasswordsModal()">üîë Ver Contrase√±as</button>
          <button class="btn primary" onclick="exportGlobalCSV()">üíæ Exportar Global CSV</button>
          <button class="btn ghost" onclick="logout()">üö™ Cerrar sesi√≥n</button></div></div>`;
          html += `<div class="card"><h3 class="small">Progreso por juez</h3><div class="admin-grid">`;
          
          for(const u of USERS.filter(x=>x.role==="juez")){
            const assigned = ASSIGNMENTS[u.user] || [];
            let done = 0;
            for(const id of assigned) {
                const data = localStorage.getItem(`eval_${u.user}_${id}`);
                // Solo cuenta como completado si existe la evaluaci√≥n y no es solo el placeholder de reasignaci√≥n
                if(data && !JSON.parse(data).reassignedFrom) done++; 
            }
            const pct = assigned.length? Math.round(done/assigned.length*100) : 0;
            
            html += `<div class="work-card">
                        <strong>${u.name}</strong>
                        <div class="small">${done}/${assigned.length} completados</div>
                        <div style="margin-top:10px" class="progress"><div style="width:${pct}%"></div></div>
                        <div style="margin-top:15px; display:flex; gap:8px;">
                            <button class="btn ghost" style="width:auto; padding: 10px 14px; font-size:14px;" onclick="openReassignModal('${u.user}')">üì§ Reasignar</button>
                            <button class="btn primary" style="width:auto; padding: 10px 14px; font-size:14px;" onclick="exportJudgeCSV('${u.user}')">CSV</button>
                        </div>
                     </div>`;
          }
          html += `</div></div>`;
          root.innerHTML = html;
        }

        // --- Admin: Mostrar Contrase√±as ---
        function showPasswordsModal() {
            let userListHtml = USERS.map(u => `
                <div style="display:flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #eee;">
                    <span><strong>${u.user}</strong> (${u.name})</span>
                    <span style="font-family: monospace; font-size:15px; background: #f3f4f6; padding: 4px 8px; border-radius: 6px;">${u.pass}</span>
                </div>
            `).join('');

            openModal(`
                <h3>üîë Contrase√±as de Jueces y Administrador</h3>
                <p class="muted">Lista para referencia del administrador. Por favor, maneje esta informaci√≥n con discreci√≥n.</p>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 20px; padding: 0 5px;">
                    ${userListHtml}
                </div>
            `);
        }

        // --- Reassignment Logic (Modal) ---
        function openReassignModal(oldJudge){
          const listaJueces = USERS
              .filter(u => u.role === "juez" && u.user !== oldJudge)
              .map(j => `<option value="${j.user}">${j.name} (${j.user})</option>`)
              .join("");

          openModal(`
              <h3>üì§ Reasignar Trabajos Pendientes</h3>
              <p class="muted">Transfiere los trabajos *no evaluados* de <strong>${oldJudge}</strong> a otro juez.</p>
              
              <label for="newJudgeSelect">Nuevo Juez</label>
              <select id="newJudgeSelect" style="margin-bottom: 12px; width:100%">
                  <option value="">Seleccione...</option>
                  ${listaJueces}
              </select>
              
              <button class="btn primary" style="width:100%" onclick="confirmMassReassign('${oldJudge}')">
                  Confirmar Reasignaci√≥n Masiva
              </button>
          `);
        }

        function confirmMassReassign(oldJudge){
          const newJudge = document.getElementById("newJudgeSelect").value;
          if(!newJudge){
            showAlert("Debe seleccionar un juez v√°lido para la reasignaci√≥n.", "error");
            return;
          }
          reassignAllPending(oldJudge, newJudge);
          closeModal();
        }

        // CORRECCI√ìN: Asegurar que la lista de asignaciones del juez original se limpie de los trabajos reasignados.
        function reassignAllPending(oldJudge, newJudge){
          const assignedByOldJudge = ASSIGNMENTS[oldJudge] || [];
          let pendingToReassign = [];
          
          // 1. Identificar pendientes (solo si no tienen una evaluaci√≥n final)
          for(const id of assignedByOldJudge){
            const key = `eval_${oldJudge}_${id}`;
            const data = localStorage.getItem(key);
            // Consideramos pendiente si NO hay data O si la data solo es un marcador de reasignaci√≥n (reassignedFrom)
            if(!data || (data && JSON.parse(data).reassignedFrom)){ 
              pendingToReassign.push(id);
            }
          }

          let count = 0;
          let newAssignments = [];
          
          for(const id of pendingToReassign){
              // 2. Marcar como asignado/reasignado para el nuevo juez
              const newKey = `eval_${newJudge}_${id}`;
              
              // No creamos un marcador si el nuevo juez ya lo evalu√≥
              const newJudgeEvaluated = localStorage.getItem(newKey) && !JSON.parse(localStorage.getItem(newKey)).reassignedFrom;
              
              if(!newJudgeEvaluated) {
                  // Guardamos un marcador temporal en localStorage para el nuevo juez
                  localStorage.setItem(newKey, JSON.stringify({reassignedFrom: oldJudge, timestamp:new Date().toISOString(), totalScore: 0}));
                  newAssignments.push(id);
                  count++;
              }
          }
          
          // 3. Actualizar ASSIGNMENTS: Eliminar trabajos reasignados del juez antiguo y agregarlos al nuevo
          // Se usa un nuevo arreglo para ASSIGNMENTS[oldJudge]
          ASSIGNMENTS[oldJudge] = assignedByOldJudge.filter(id => !pendingToReassign.includes(id));
          // Se a√±ade al juez nuevo solo los trabajos que realmente se movieron.
          ASSIGNMENTS[newJudge] = (ASSIGNMENTS[newJudge] || []).concat(newAssignments.filter(id => !(ASSIGNMENTS[newJudge] || []).includes(id)));
          
          // Notificaci√≥n y refresco del dashboard
          showAlert(`Reasignados ${count} trabajos pendientes de ${oldJudge} a ${newJudge}.`, "success");
          renderAdmin(); // Recargar el dashboard de admin para ver los cambios
        }

        // --- UI Utils ---
        function openModal(html) {
            const modal = document.createElement("div");
            modal.className = "modal-bg";
            modal.innerHTML = `<div class="modal card">${html}<button class="btn ghost" style="margin-top:20px; width:100%" onclick="closeModal()">Cerrar</button></div>`;
            document.body.appendChild(modal);
        }

        function closeModal() {
            const m = document.querySelector(".modal-bg");
            if (m) m.remove();
        }

        // REEMPLAZO DE ALERT Y PROMPT NATIVOS
        function showAlert(message, type = "info") {
            const alertBox = document.getElementById("custom-alert");
            if (!alertBox) return;

            alertBox.textContent = message;
            alertBox.className = ''; // Limpiar clases existentes
            alertBox.classList.add('alert-' + type);
            alertBox.style.display = 'block';

            // Forzar reflow/repaint para asegurar que la transici√≥n inicie
            void alertBox.offsetWidth; 
            alertBox.style.opacity = 1;

            setTimeout(() => {
                alertBox.style.opacity = 0;
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 300); // Esperar que termine la transici√≥n
            }, 3000); // Mostrar por 3 segundos
        }

        // --- CSV Exports (Actualizado con todos los criterios) ---
        function exportGlobalCSV(){
          const baseHeaders = ['judge', 'work', 'student', 'totalScore', 'observations', 'timestamp'];
          const criteriaHeaders = CRITERIA.map(c => c.id);
          const headers = baseHeaders.concat(criteriaHeaders);
          const rows = [headers];
          
          for(const u of USERS.filter(x=>x.role==="juez")){
            const assigned = ASSIGNMENTS[u.user] || [];
            for(const id of assigned){
              const key = `eval_${u.user}_${id}`;
              const data = localStorage.getItem(key);
              if(data){
                const obj = JSON.parse(data);
                
                let row = [
                    u.user, id, WORKS[id] || "", obj.totalScore || 0, 
                    obj.observations || "", obj.timestamp || ""
                ];

                // Agregar todos los puntajes de criterios
                for (const item of CRITERIA) {
                    row.push(obj.scores?.[item.id] !== undefined ? obj.scores[item.id] : 0);
                }
                
                rows.push(row);
              }
            }
          }
          downloadCSV(rows,"evaluaciones_global.csv");
          showAlert("Exportaci√≥n CSV Global iniciada.", "info");
        }

        function exportJudgeCSV(judge){
          const baseHeaders = ['work', 'student', 'totalScore', 'observations', 'timestamp'];
          const criteriaHeaders = CRITERIA.map(c => c.id);
          const headers = baseHeaders.concat(criteriaHeaders);
          const rows = [headers];
          const assigned = ASSIGNMENTS[judge] || [];
          
          for(const id of assigned){
            const key = `eval_${judge}_${id}`;
            const data = localStorage.getItem(key);
            if(data){
              const obj = JSON.parse(data);

              let row = [
                  id, WORKS[id] || "", obj.totalScore || 0, 
                  obj.observations || "", obj.timestamp || ""
              ];

              // Agregar todos los puntajes de criterios
              for (const item of CRITERIA) {
                  row.push(obj.scores?.[item.id] !== undefined ? obj.scores[item.id] : 0);
              }

              rows.push(row);
            }
          }
          downloadCSV(rows,`evaluaciones_${judge}.csv`);
          showAlert(`Exportaci√≥n CSV para ${judge} iniciada.`, "info");
        }


        function downloadCSV(rows,filename){
          const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,"'")}"`).join(",")).join("\n");
          const blob = new Blob([csv],{type:"text/csv"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
          URL.revokeObjectURL(url);
        }
        
        function logout(){ localStorage.removeItem("simposioUser"); localStorage.removeItem("simposioRole"); location.reload(); }

        // --- Exposici√≥n Global de Funciones para HTML ---
        window.showDashboard = showDashboard;
        window.renderJudge = renderJudge;
        window.openEvaluation = openEvaluation;
        window.saveEvaluation = saveEvaluation;
        window.renderAdmin = renderAdmin;
        window.showPasswordsModal = showPasswordsModal; 
        window.confirmResetEvaluation = confirmResetEvaluation; 
        window.resetEvaluation = resetEvaluation; 
        window.openReassignModal = openReassignModal;
        window.confirmMassReassign = confirmMassReassign;
        window.reassignAllPending = reassignAllPending;
        window.exportGlobalCSV = exportGlobalCSV;
        window.exportJudgeCSV = exportJudgeCSV;
        window.calculateScore = calculateScore;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.showAlert = showAlert;
        window.logout = logout;
        window.togglePasswordVisibility = togglePasswordVisibility; 


        // Inicializar eventos al cargar la ventana
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("login-btn").addEventListener("click", tryLogin);
            
            // Simular carga de datos para el login card
            document.getElementById("username").value = "araceli.hernandez";
            document.getElementById("password").value = "Simposio2024";
        });
    </script>
</head>
<body>
  
  <!-- Custom Alert/Toast Container -->
  <div id="custom-alert" class="alert-info"></div>

  <div class="container">
    <header class="topbar">
      <div class="left">
        <!-- Logos reales de Github -->
        <img src="logo_ipn.png" onerror="this.src='https://placehold.co/50x50/5b21b6/FFFFFF/png?text=IPN'" alt="IPN" class="logo" />
        <img src="logo_esm.jpg" onerror="this.src='https://placehold.co/50x50/059669/FFFFFF/png?text=ESM'" alt="ESM" class="logo" />
        <img src="logo_licam.png" onerror="this.src='https://placehold.co/50x50/34d399/000000/png?text=LICAM'" alt="LICAM" class="logo" />
      </div>
      <div class="right">
        <div class="version">Simposio ‚Ä¢ Evaluaci√≥n ‚Ä¢ 2025</div>
      </div>
    </header>

    <main class="main-grid">
      <!-- PANEL DE INICIO DE SESI√ìN -->
      <aside class="login-card card" id="login-card">
        <h2>Bienvenido al Sistema</h2>
        <p class="muted">Usa el usuario y contrase√±a asignado para iniciar la evaluaci√≥n.</p>

        <label for="username">Usuario</label>
        <input id="username" type="text" autocomplete="username" placeholder="ej. araceli.hernandez">

        <label for="password">Contrase√±a</label>
        <div class="password-container">
            <input id="password" type="password" autocomplete="current-password" placeholder="********">
            <button type="button" class="toggle-btn" id="toggle-password-btn" onclick="togglePasswordVisibility()">
                üëÅÔ∏è
            </button>
        </div>

        <div id="login-error" class="error hidden"></div>

        <button id="login-btn" class="btn primary">üöÄ Entrar</button>

        <small class="muted" style="margin-top:10px;">Si tiene problemas contacte al administrador.</small>
      </aside>

      <!-- RA√çZ DE LA APLICACI√ìN (Dashboard / Evaluaci√≥n) -->
      <section id="app-root" class="card hidden"></section>
    </main>

    <footer class="footer">
      ¬© Simposio 2025 ‚Äî Plataforma de Evaluaci√≥n
    </footer>
  </div>
</body>
</html>
